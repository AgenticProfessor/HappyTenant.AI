// Happy Tenant - Foundation Database Schema
// This is the Prisma schema file for PostgreSQL
// Run `npx prisma migrate dev` to create tables
// Run `npx prisma generate` to generate the Prisma client

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================
// CORE ENTITIES: Users, Organizations, Roles
// ============================================================

model Organization {
  id               String   @id @default(cuid())
  name             String
  slug             String   @unique
  type             OrganizationType @default(INDIVIDUAL)
  subscriptionTier SubscriptionTier @default(FREE)

  // Contact & Business Info
  email            String?
  phone            String?
  website          String?
  addressLine1     String?
  addressLine2     String?
  city             String?
  state            String?
  postalCode       String?
  country          String   @default("USA")

  // Settings
  timezone         String   @default("America/Chicago")
  currency         String   @default("USD")

  // Stripe Connect
  stripeConnectAccountId   String?   @unique
  stripeConnectStatus      StripeConnectStatus @default(NOT_STARTED)
  stripeConnectOnboardedAt DateTime?
  stripePayoutDelay        Int       @default(7)
  stripeDefaultCurrency    String    @default("usd")
  businessEntityType       BusinessEntityType @default(INDIVIDUAL)
  taxId                    String?   // EIN or SSN (encrypted)

  // Fee Configuration
  feeConfiguration         FeeConfiguration @default(LANDLORD_ABSORBS)

  // ACH Payout Speed Configuration
  defaultAchPayoutSpeed         ACHPayoutSpeed @default(STANDARD)
  expeditedPayoutAcknowledgedAt DateTime?      // When user acknowledged expedited risk

  // Trust-based Payout Delay
  payoutDelayDays          Int       @default(7)
  payoutDelayMinimum       Int       @default(7)
  accountTrustLevel        TrustLevel @default(NEW)
  firstSuccessfulPayoutAt  DateTime?
  successfulPayoutCount    Int       @default(0)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  users            User[]
  properties       Property[]
  tenants          Tenant[]
  vendors          Vendor[]
  documents        Document[]
  conversations    Conversation[]
  auditLogs        AuditLog[]
  stripeConnectAccount StripeConnectAccount?
  payouts          Payout[]
  businessEntities BusinessEntity[]
  esignDocuments   ESignDocument[]
  esignTemplates   ESignTemplate[]

  @@index([slug])
  @@index([stripeConnectAccountId])
}

// Business entities for landlords with multiple LLCs/properties
// Supports Series LLC parent/child hierarchies for File Hub organization
model BusinessEntity {
  id               String   @id @default(cuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Entity Info
  name             String       // Display name: "ABC Properties LLC"
  legalName        String?      // Full legal name if different from display name
  entityType       BusinessEntityType
  isDefault        Boolean  @default(false)

  // Series LLC Support (for hierarchical entity structures)
  parentEntityId   String?
  parentEntity     BusinessEntity?  @relation("EntityChildren", fields: [parentEntityId], references: [id])
  childEntities    BusinessEntity[] @relation("EntityChildren")

  // Registration Info
  stateOfFormation String?      // State where entity was formed: "DE", "TX", etc.
  dateFormed       DateTime?    // Date of formation
  registeredAgent  String?      // Registered agent name
  registeredAgentAddress String? // Registered agent address

  // Tax Information (encrypted in production)
  ein              String?  // For business entities (XX-XXXXXXX format)
  ssnLast4         String?  // For individuals (last 4 digits only)

  // Business Address
  addressLine1     String?
  addressLine2     String?
  city             String?
  state            String?
  postalCode       String?
  country          String   @default("USA")

  // Contact
  phone            String?
  email            String?

  // Payout Settings (per-entity override)
  achPayoutSpeed   ACHPayoutSpeed @default(STANDARD)
  payoutDelayDays  Int      @default(7)

  // Status & Compliance
  status           EntityStatus @default(ACTIVE)
  annualReportDue  DateTime?    // Next annual report due date
  goodStandingDate DateTime?    // Last good standing certificate date

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  bankAccounts     EntityBankAccount[]
  properties       Property[]
  documents        Document[]

  @@index([organizationId])
  @@index([isDefault])
  @@index([parentEntityId])
  @@index([status])
}

enum EntityStatus {
  ACTIVE
  INACTIVE
  DISSOLVED
  PENDING_FORMATION
  SUSPENDED
}

// Bank accounts linked to business entities for payouts
model EntityBankAccount {
  id                      String   @id @default(cuid())
  entityId                String
  entity                  BusinessEntity @relation(fields: [entityId], references: [id], onDelete: Cascade)

  // Stripe References
  stripeExternalAccountId String?  @unique

  // Bank Account Details
  bankName                String
  accountHolderName       String
  accountType             BankAccountType @default(CHECKING)
  last4                   String   // Last 4 digits of account number
  routingLast4            String?  // Last 4 digits of routing number

  // Status
  isDefault               Boolean  @default(false)
  isVerified              Boolean  @default(false)
  verifiedAt              DateTime?

  // Metadata
  nickname                String?

  // Timestamps
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@index([entityId])
}

enum OrganizationType {
  INDIVIDUAL
  COMPANY
}

enum SubscriptionTier {
  FREE
  PRO
  ENTERPRISE
}

enum BusinessEntityType {
  INDIVIDUAL
  LLC
  SERIES_LLC        // Parent Series LLC
  SERIES_LLC_CHILD  // Individual series under a Series LLC
  LP
  LLP
  S_CORP
  C_CORP
  TRUST
  ESTATE
  OTHER
}

enum StripeConnectStatus {
  NOT_STARTED
  ONBOARDING_STARTED
  PENDING_VERIFICATION
  RESTRICTED
  ACTIVE
  DISABLED
}

enum FeeConfiguration {
  LANDLORD_ABSORBS
  TENANT_PAYS
  SPLIT_FEES
}

enum TrustLevel {
  NEW
  ESTABLISHED
  VERIFIED
}

enum ACHPayoutSpeed {
  STANDARD    // 5-7 business days - payment deposited after clearing tenant's bank
  EXPEDITED   // 2-4 business days - payment may be deposited before clearing
}

enum BankAccountType {
  CHECKING
  SAVINGS
}

model User {
  id               String   @id @default(cuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Auth & Identity
  supabaseId       String?  @unique  // Supabase Auth UID
  email            String   @unique
  emailVerified    DateTime?
  passwordHash     String?  // For credential-based auth

  // Profile
  firstName        String
  lastName         String
  phone            String?
  avatarUrl        String?

  // Role & Permissions
  role             UserRole @default(STAFF)
  isActive         Boolean  @default(true)

  // Two-Factor Authentication
  twoFactorEnabled     Boolean  @default(false)
  twoFactorSecret      String?  // Encrypted TOTP secret
  twoFactorBackupCodes String[] // Encrypted backup codes

  // Timestamps
  lastLoginAt      DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  maintenanceReportsCreated MaintenanceRequest[] @relation("ReportedBy")
  maintenanceAssigned       MaintenanceRequest[] @relation("AssignedTo")
  documentsUploaded         Document[]
  messagesFromUser          Message[]            @relation("UserMessages")
  conversationParticipants  ConversationParticipant[]
  notifications             Notification[]
  auditLogs                 AuditLog[]
  esignDocumentsCreated     ESignDocument[]
  esignSignerAs             ESignSigner[]        @relation("ESignSignerUser")

  @@index([organizationId])
  @@index([email])
}

enum UserRole {
  OWNER    // Full access, can manage billing and delete org
  MANAGER  // Can manage properties, tenants, finances
  STAFF    // Limited access, can view and handle day-to-day tasks
}

// ============================================================
// PROPERTIES & UNITS
// ============================================================

model Property {
  id               String   @id @default(cuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Business Entity (for File Hub hierarchy: Entity → Property → Lease)
  businessEntityId String?
  businessEntity   BusinessEntity? @relation(fields: [businessEntityId], references: [id])

  // Basic Info
  name             String
  type             PropertyType

  // Address
  addressLine1     String
  addressLine2     String?
  city             String
  state            String
  postalCode       String
  country          String   @default("USA")
  latitude         Float?
  longitude        Float?

  // Details
  yearBuilt        Int?
  squareFeet       Int?
  lotSize          Float?   // In acres
  parkingSpaces    Int?

  // Financial
  purchasePrice    Decimal?  @db.Decimal(12, 2)
  purchaseDate     DateTime?
  currentValue     Decimal?  @db.Decimal(12, 2)

  // Media
  photos           String[]  // Array of URLs

  // Status
  status           PropertyStatus @default(ACTIVE)
  notes            String?   @db.Text

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  units            Unit[]
  documents        Document[]
  esignDocuments   ESignDocument[]

  @@index([organizationId])
  @@index([businessEntityId])
  @@index([status])
}

enum PropertyType {
  SINGLE_FAMILY
  MULTI_FAMILY
  APARTMENT
  CONDO
  TOWNHOUSE
  COMMERCIAL
}

enum PropertyStatus {
  ACTIVE
  INACTIVE
  SOLD
}

model Unit {
  id               String   @id @default(cuid())
  propertyId       String
  property         Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  // Basic Info
  unitNumber       String   // e.g., "101", "A", "Main House"
  name             String?  // Optional friendly name

  // Specifications
  bedrooms         Int      @default(1)
  bathrooms        Decimal  @db.Decimal(3, 1) @default(1.0) // Supports 1.5, 2.5, etc.
  squareFeet       Int?
  floorNumber      Int?

  // Amenities & Features
  amenities        String[] // e.g., ["washer_dryer", "dishwasher", "parking"]

  // Rental Terms (defaults, can be overridden in lease)
  marketRent       Decimal  @db.Decimal(10, 2)
  depositAmount    Decimal  @db.Decimal(10, 2)

  // Policies
  petsAllowed      Boolean  @default(false)
  petDeposit       Decimal? @db.Decimal(10, 2)
  petRent          Decimal? @db.Decimal(10, 2)
  smokingAllowed   Boolean  @default(false)

  // Utilities included in rent
  utilitiesIncluded String[] // e.g., ["water", "trash", "internet"]

  // Listing Info (for marketing)
  status           UnitStatus @default(VACANT)
  isListed         Boolean  @default(false)
  listingTitle     String?
  listingDescription String? @db.Text
  listingPhotos    String[]
  availableDate    DateTime?

  // Media
  photos           String[]

  // Notes
  notes            String?  @db.Text

  // AI Fields (for future use)
  aiRentRecommendation Decimal? @db.Decimal(10, 2)

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  leases              Lease[]
  maintenanceRequests MaintenanceRequest[]
  applications        Application[]
  applicationLinks    ApplicationLink[]
  documents           Document[]

  @@unique([propertyId, unitNumber])
  @@index([propertyId])
  @@index([status])
  @@index([isListed])
}

enum UnitStatus {
  VACANT
  OCCUPIED
  NOTICE_GIVEN
  UNDER_APPLICATION
  MAINTENANCE
  OFF_MARKET
}

// ============================================================
// TENANTS & SCREENING
// ============================================================

model Tenant {
  id               String   @id @default(cuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Link to user account (optional - tenant may not have portal access)
  userId           String?  @unique

  // Personal Info
  firstName        String
  lastName         String
  email            String
  phone            String?
  dateOfBirth      DateTime?
  ssn              String?  // Encrypted - for screening

  // Identification
  driversLicense   String?
  driversLicenseState String?

  // Employment & Income
  employmentStatus EmploymentStatus?
  employerName     String?
  employerPhone    String?
  jobTitle         String?
  monthlyIncome    Decimal? @db.Decimal(10, 2)
  incomeVerified   Boolean  @default(false)

  // Additional Info
  hasPets          Boolean  @default(false)
  petDetails       String?  // Description of pets
  hasVehicles      Boolean  @default(false)
  vehicleDetails   String?  // Description of vehicles

  // Household Members (JSON for flexibility)
  householdMembers Json?    // Array of { name, relationship, age }

  // Emergency Contact
  emergencyContactName  String?
  emergencyContactPhone String?
  emergencyContactRelation String?

  // Screening
  screeningStatus  ScreeningStatus @default(NOT_STARTED)

  // AI Risk Assessment (for future use)
  aiRiskScore      Int?     // 0-100

  // Notes
  notes            String?  @db.Text

  // Status
  isActive         Boolean  @default(true)

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  leaseTenants         LeaseTenant[]
  screeningResults     ScreeningResult[]
  applications         Application[]
  charges              Charge[]
  payments             Payment[]
  maintenanceRequests  MaintenanceRequest[]
  messagesFromTenant   Message[]       @relation("TenantMessages")
  conversationParticipants ConversationParticipant[]
  notifications        Notification[]
  documents            Document[]

  // Stripe/Payment Relations
  stripeCustomer       StripeCustomer?
  paymentMethods       TenantPaymentMethod[]
  scheduledPayments    ScheduledPayment[]
  esignSigners         ESignSigner[]

  @@index([organizationId])
  @@index([email])
  @@index([screeningStatus])
}

enum EmploymentStatus {
  EMPLOYED_FULL_TIME
  EMPLOYED_PART_TIME
  SELF_EMPLOYED
  UNEMPLOYED
  RETIRED
  STUDENT
  OTHER
}

enum ScreeningStatus {
  NOT_STARTED
  PENDING
  PASSED
  FAILED
  REVIEW_NEEDED
}

model ScreeningResult {
  id               String   @id @default(cuid())
  tenantId         String
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  applicationId    String?
  application      Application? @relation(fields: [applicationId], references: [id])

  // Provider Info
  provider         String   // e.g., "TransUnion", "Experian", "Internal"
  requestId        String?  // External reference ID

  // Results
  creditScore      Int?
  criminalCheck    ScreeningCheckResult?
  evictionCheck    ScreeningCheckResult?
  incomeVerification ScreeningCheckResult?

  // Summary
  overallResult    ScreeningCheckResult @default(PENDING)
  riskLevel        RiskLevel?

  // Raw Response (for debugging/audit)
  rawResponse      Json?

  // Notes & Decision
  notes            String?  @db.Text
  reviewedByUserId String?
  reviewedAt       DateTime?

  // Timestamps
  requestedAt      DateTime @default(now())
  completedAt      DateTime?
  expiresAt        DateTime?

  @@index([tenantId])
  @@index([applicationId])
}

enum ScreeningCheckResult {
  PENDING
  PASS
  FAIL
  REVIEW_NEEDED
  NOT_APPLICABLE
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
}

// ============================================================
// APPLICATIONS & LISTINGS
// ============================================================

// Shareable application links for landlords to send to prospects
model ApplicationLink {
  id               String   @id @default(cuid())
  organizationId   String
  unitId           String?           // Null = organization-wide link
  unit             Unit?             @relation(fields: [unitId], references: [id])

  // Link settings
  token            String   @unique  // URL-safe token for public link
  name             String?           // e.g., "Summer 2024 Applications"
  isActive         Boolean  @default(true)

  // Application fee (Stripe payment)
  applicationFee   Decimal? @db.Decimal(10, 2)
  collectFeeOnline Boolean  @default(false)

  // Expiration
  expiresAt        DateTime?
  maxApplications  Int?
  applicationsReceived Int  @default(0)

  // Customization
  requiredDocuments String[]         // ['id', 'pay_stubs', 'bank_statements']
  customQuestions   Json?            // Array of custom questions

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  applications     Application[]

  @@index([organizationId])
  @@index([token])
}

model Application {
  id               String   @id @default(cuid())
  unitId           String
  unit             Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)

  // Link to application link (if submitted via public link)
  applicationLinkId String?
  applicationLink   ApplicationLink? @relation(fields: [applicationLinkId], references: [id])

  // Applicant (may or may not become a Tenant)
  tenantId         String?  // Linked after approval
  tenant           Tenant?  @relation(fields: [tenantId], references: [id])

  // Applicant Info (captured at time of application)
  firstName        String
  lastName         String
  email            String
  phone            String?
  dateOfBirth      DateTime?

  // SSN (encrypted at rest)
  ssnEncrypted     String?  // AES-256-GCM encrypted SSN

  // Identification
  driversLicense   String?
  driversLicenseState String?

  // Application Details
  desiredMoveInDate DateTime?
  desiredLeaseTermMonths Int?

  // Employment at time of application
  employmentStatus String?  // EMPLOYED_FULL_TIME, SELF_EMPLOYED, etc.
  employerName     String?
  employerPhone    String?
  employerAddress  String?
  jobTitle         String?
  monthlyIncome    Decimal? @db.Decimal(10, 2)
  additionalIncome Decimal? @db.Decimal(10, 2)
  additionalIncomeSource String?

  // References
  references       Json?    // Array of { name, phone, email, relationship }

  // Pets & Vehicles (detailed JSON)
  hasPets          Boolean  @default(false)
  petDetails       String?
  petsJson         Json?    // Array of { type, breed, weight, age, name }
  hasVehicles      Boolean  @default(false)
  vehicleDetails   String?
  vehiclesJson     Json?    // Array of { make, model, year, color, licensePlate }

  // Additional Occupants
  additionalOccupantsJson Json?  // Array of { name, relationship, age, occupation }

  // Emergency Contact
  emergencyContactName  String?
  emergencyContactPhone String?
  emergencyContactRelation String?

  // Rental History (detailed JSON)
  currentAddress   String?
  currentCity      String?
  currentState     String?
  currentZip       String?
  currentLandlordName String?
  currentLandlordPhone String?
  currentRent      Decimal? @db.Decimal(10, 2)
  currentMoveInDate DateTime?
  reasonForMoving  String?
  rentalHistoryJson Json?    // Array of previous addresses with landlord info

  // Co-applicants
  coApplicants     Json?    // Array of applicant info objects

  // Screening Consent
  consentToBackgroundCheck Boolean @default(false)
  consentToCreditCheck     Boolean @default(false)
  consentSignedAt          DateTime?

  // Email Verification
  emailVerified    Boolean  @default(false)
  emailVerifiedAt  DateTime?

  // Status & Pipeline
  status           ApplicationStatus @default(NEW)

  // Fees (Stripe payment)
  applicationFee   Decimal? @db.Decimal(10, 2)
  applicationFeePaid Boolean @default(false)
  stripePaymentIntentId String?
  stripePaymentStatus   String?

  // Notes & Decision
  notes            String?  @db.Text
  decisionReason   String?
  decidedByUserId  String?
  decidedAt        DateTime?

  // How did they hear about us
  howDidYouHear    String?
  additionalComments String? @db.Text

  // Timestamps
  submittedAt      DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  screeningResults ScreeningResult[]
  documents        Document[]
  verifications    ApplicationVerification[]
  applicationNotes ApplicationNote[]
  statusHistory    ApplicationStatusHistory[]
  esignDocuments   ESignDocument[]

  @@index([unitId])
  @@index([status])
  @@index([email])
  @@index([applicationLinkId])
}

// Email verification for public applications
model ApplicationVerification {
  id               String   @id @default(cuid())
  applicationId    String
  application      Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  email            String
  code             String            // 6-digit verification code
  verified         Boolean  @default(false)
  verifiedAt       DateTime?
  expiresAt        DateTime
  attempts         Int      @default(0)

  createdAt        DateTime @default(now())

  @@index([applicationId])
  @@index([email, code])
}

// Internal notes on applications
model ApplicationNote {
  id               String   @id @default(cuid())
  applicationId    String
  application      Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  userId           String
  content          String   @db.Text
  isInternal       Boolean  @default(true)  // Internal = not visible to applicant

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([applicationId])
}

// Status change history for applications
model ApplicationStatusHistory {
  id               String   @id @default(cuid())
  applicationId    String
  application      Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  fromStatus       ApplicationStatus?
  toStatus         ApplicationStatus
  changedByUserId  String?
  reason           String?

  createdAt        DateTime @default(now())

  @@index([applicationId])
}

enum ApplicationStatus {
  NEW
  UNDER_REVIEW
  SCREENING_IN_PROGRESS
  APPROVED
  DECLINED
  WAITLIST
  WITHDRAWN
  LEASE_SIGNED
}

// ============================================================
// LEASES
// ============================================================

model Lease {
  id               String   @id @default(cuid())
  unitId           String
  unit             Unit     @relation(fields: [unitId], references: [id], onDelete: Restrict)

  // Lease Terms
  leaseType        LeaseType @default(FIXED)
  startDate        DateTime
  endDate          DateTime?  // Null for month-to-month

  // Rent
  rentAmount       Decimal  @db.Decimal(10, 2)
  rentDueDay       Int      @default(1)  // Day of month (1-28)
  rentFrequency    RentFrequency @default(MONTHLY)

  // Deposits
  securityDeposit  Decimal  @db.Decimal(10, 2)
  petDeposit       Decimal? @db.Decimal(10, 2)
  otherDeposits    Json?    // Array of { name, amount }

  // Late Fees
  lateFeeAmount    Decimal? @db.Decimal(10, 2)
  lateFeeType      LateFeeType @default(FLAT)
  lateFeeGraceDays Int      @default(5)

  // Recurring Charges (besides rent)
  recurringCharges Json?    // Array of { name, amount, frequency }

  // Proration
  proratedFirstMonth Decimal? @db.Decimal(10, 2)

  // Status
  status           LeaseStatus @default(DRAFT)

  // Termination
  terminationDate  DateTime?
  terminationReason String?
  moveOutDate      DateTime?

  // Notice
  noticeGivenDate  DateTime?
  noticeGivenBy    String?  // "tenant" or "landlord"

  // E-Signature Status
  signatureStatus  SignatureStatus @default(NOT_SENT)
  signedByTenantAt DateTime?
  signedByLandlordAt DateTime?

  // Notes
  notes            String?  @db.Text

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  leaseTenants     LeaseTenant[]
  charges          Charge[]
  payments         Payment[]
  documents        Document[]
  scheduledPayments ScheduledPayment[]
  esignDocuments   ESignDocument[]

  @@index([unitId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
}

// Join table for many-to-many between Lease and Tenant
model LeaseTenant {
  id               String   @id @default(cuid())
  leaseId          String
  lease            Lease    @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  tenantId         String
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Role on lease
  role             LeaseRole @default(PRIMARY)

  // Move-in/out
  moveInDate       DateTime?
  moveOutDate      DateTime?

  // Timestamps
  createdAt        DateTime @default(now())

  @@unique([leaseId, tenantId])
  @@index([leaseId])
  @@index([tenantId])
}

enum LeaseType {
  FIXED
  MONTH_TO_MONTH
  WEEK_TO_WEEK
}

enum RentFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  ANNUALLY
}

enum LateFeeType {
  FLAT        // Fixed amount
  PERCENTAGE  // Percentage of rent
  DAILY       // Per day late
}

enum LeaseStatus {
  DRAFT
  PENDING_SIGNATURE
  ACTIVE
  EXPIRED
  TERMINATED
  RENEWED
}

enum LeaseRole {
  PRIMARY       // Primary leaseholder
  CO_TENANT     // Co-signer on lease
  GUARANTOR     // Financial guarantor
  OCCUPANT      // Authorized occupant (not on lease)
}

enum SignatureStatus {
  NOT_SENT
  SENT
  PARTIALLY_SIGNED
  COMPLETED
  EXPIRED
  DECLINED
}

// ============================================================
// PAYMENTS & CHARGES (Rent Ledger)
// ============================================================

model Charge {
  id               String   @id @default(cuid())
  leaseId          String
  lease            Lease    @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  tenantId         String?
  tenant           Tenant?  @relation(fields: [tenantId], references: [id])

  // Charge Details
  type             ChargeType
  description      String
  amount           Decimal  @db.Decimal(10, 2)

  // Due Date
  dueDate          DateTime

  // For recurring charges, track the billing period
  billingPeriodStart DateTime?
  billingPeriodEnd   DateTime?

  // Status
  status           ChargeStatus @default(PENDING)

  // If this was auto-generated (e.g., recurring rent)
  isAutoGenerated  Boolean  @default(false)

  // Notes
  notes            String?

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  paymentAllocations PaymentAllocation[]
  paymentAttempts    PaymentAttempt[]

  @@index([leaseId])
  @@index([tenantId])
  @@index([dueDate])
  @@index([status])
}

enum ChargeType {
  RENT
  SECURITY_DEPOSIT
  PET_DEPOSIT
  LATE_FEE
  UTILITY
  PARKING
  STORAGE
  PET_RENT
  MAINTENANCE_REIMBURSEMENT
  NSF_FEE
  LEASE_VIOLATION_FEE
  MOVE_IN_FEE
  MOVE_OUT_FEE
  OTHER
}

enum ChargeStatus {
  PENDING     // Not yet due
  DUE         // Due but not paid
  PARTIAL     // Partially paid
  PAID        // Fully paid
  WAIVED      // Waived by landlord
  VOID        // Cancelled/voided
}

model Payment {
  id               String   @id @default(cuid())
  leaseId          String
  lease            Lease    @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  tenantId         String?
  tenant           Tenant?  @relation(fields: [tenantId], references: [id])

  // Payment Details
  amount           Decimal  @db.Decimal(10, 2)
  method           PaymentMethod

  // External Reference (for online payments)
  externalId       String?  // Legacy/non-Stripe payment ID

  // For checks/manual
  checkNumber      String?

  // Stripe Fields
  stripePaymentIntentId     String?  @unique
  stripeChargeId            String?  @unique
  stripePaymentMethodId     String?
  stripeCustomerId          String?

  // Fee tracking
  stripeFee                 Decimal? @db.Decimal(10, 2)
  platformFee               Decimal? @db.Decimal(10, 2)
  netAmount                 Decimal? @db.Decimal(10, 2)

  // Transfer to connected account
  stripeTransferId          String?  @unique
  transferredAt             DateTime?

  // Link to payout
  payoutId                  String?
  payout                    Payout?  @relation(fields: [payoutId], references: [id])

  // Status
  status           PaymentStatus @default(PENDING)

  // Processing
  processedAt      DateTime?
  failureReason    String?

  // Refund tracking
  refundedAmount   Decimal? @db.Decimal(10, 2)
  refundedAt       DateTime?
  refundReason     String?
  stripeRefundId   String?  @unique

  // Receipt
  receiptNumber    String?
  receiptSentAt    DateTime?

  // Notes
  notes            String?

  // Recorded by (for manual payments)
  recordedByUserId String?

  // Timestamps
  receivedAt       DateTime @default(now()) // When payment was received
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  paymentAllocations PaymentAllocation[]
  paymentAttempts    PaymentAttempt[]
  dispute            Dispute?
  paymentMethod      TenantPaymentMethod? @relation(fields: [stripePaymentMethodId], references: [stripePaymentMethodId])

  @@index([leaseId])
  @@index([tenantId])
  @@index([status])
  @@index([receivedAt])
  @@index([stripePaymentIntentId])
  @@index([payoutId])
}

enum PaymentMethod {
  CASH
  CHECK
  MONEY_ORDER
  ACH
  CREDIT_CARD
  DEBIT_CARD
  VENMO
  ZELLE
  PAYPAL
  WIRE
  OTHER
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
  CANCELLED
}

// Allocation of payments to specific charges
// This handles partial payments and overpayments correctly
model PaymentAllocation {
  id               String   @id @default(cuid())
  paymentId        String
  payment          Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  chargeId         String
  charge           Charge   @relation(fields: [chargeId], references: [id], onDelete: Cascade)

  // How much of the payment goes to this charge
  amount           Decimal  @db.Decimal(10, 2)

  // Timestamps
  createdAt        DateTime @default(now())

  @@unique([paymentId, chargeId])
  @@index([paymentId])
  @@index([chargeId])
}

// For tracking credits/overpayments
model TenantCredit {
  id               String   @id @default(cuid())
  leaseId          String
  tenantId         String

  // Credit amount (positive = tenant has credit, negative shouldn't happen)
  amount           Decimal  @db.Decimal(10, 2)

  // Source
  sourceType       String   // "overpayment", "refund", "adjustment", "move_out_refund"
  sourcePaymentId  String?

  // Usage
  usedAmount       Decimal  @db.Decimal(10, 2) @default(0)

  // Notes
  notes            String?

  // Timestamps
  createdAt        DateTime @default(now())
  expiresAt        DateTime?

  @@index([leaseId])
  @@index([tenantId])
}

// ============================================================
// MAINTENANCE & VENDORS
// ============================================================

model MaintenanceRequest {
  id               String   @id @default(cuid())
  unitId           String
  unit             Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)

  // Reporter
  tenantId         String?
  tenant           Tenant?  @relation(fields: [tenantId], references: [id])
  reportedByUserId String?
  reportedByUser   User?    @relation("ReportedBy", fields: [reportedByUserId], references: [id])

  // Request Details
  title            String
  description      String   @db.Text
  category         MaintenanceCategory
  priority         MaintenancePriority @default(MEDIUM)
  isEmergency      Boolean  @default(false)

  // Media
  photos           String[]

  // Status & Assignment
  status           MaintenanceStatus @default(SUBMITTED)
  assignedToUserId String?
  assignedToUser   User?    @relation("AssignedTo", fields: [assignedToUserId], references: [id])
  assignedToVendorId String?
  assignedToVendor Vendor?  @relation(fields: [assignedToVendorId], references: [id])

  // Scheduling
  scheduledDate    DateTime?
  scheduledTimeStart String? // "09:00"
  scheduledTimeEnd   String? // "12:00"

  // Resolution
  resolvedAt       DateTime?
  resolutionNotes  String?  @db.Text

  // Costs
  estimatedCost    Decimal? @db.Decimal(10, 2)
  laborCost        Decimal? @db.Decimal(10, 2)
  materialsCost    Decimal? @db.Decimal(10, 2)
  actualCost       Decimal? @db.Decimal(10, 2)

  // Billing
  billToTenant     Boolean  @default(false)
  chargeId         String?  // If billed to tenant

  // Tenant Feedback
  tenantRating     Int?     // 1-5
  tenantFeedback   String?

  // Entry Permission
  entryPermissionGranted Boolean @default(false)
  entryInstructions String?

  // AI Suggestions (for future use)
  aiCategorySuggestion    String?
  aiPrioritySuggestion    String?

  // Steward AI Integration
  aiTriageResult   Json?    // Structured triage output from Steward
  aiTriagedAt      DateTime?
  troubleshootingSessionId String? // Links to StewardSession for troubleshooting

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  documents        Document[]
  conversations    Conversation[]

  @@index([unitId])
  @@index([tenantId])
  @@index([status])
  @@index([priority])
  @@index([assignedToVendorId])
}

enum MaintenanceCategory {
  PLUMBING
  ELECTRICAL
  HVAC
  APPLIANCE
  STRUCTURAL
  PEST_CONTROL
  LANDSCAPING
  CLEANING
  LOCKS_SECURITY
  FLOORING
  PAINTING
  ROOFING
  GENERAL
  OTHER
}

enum MaintenancePriority {
  EMERGENCY
  HIGH
  MEDIUM
  LOW
}

enum MaintenanceStatus {
  SUBMITTED
  ACKNOWLEDGED
  SCHEDULED
  IN_PROGRESS
  PENDING_PARTS
  COMPLETED
  CANCELLED
  ON_HOLD
}

model Vendor {
  id               String   @id @default(cuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Business Info
  name             String   // Company name
  contactName      String?  // Primary contact person
  phone            String
  email            String?
  website          String?

  // Address
  addressLine1     String?
  addressLine2     String?
  city             String?
  state            String?
  postalCode       String?

  // Services
  categories       VendorCategory[]
  serviceArea      String[] // ZIP codes or city names

  // Availability
  workingHours     Json?    // Object with days and hours
  emergencyAvailable Boolean @default(false)
  emergencyPhone   String?

  // Pricing
  hourlyRate       Decimal? @db.Decimal(10, 2)
  minimumCharge    Decimal? @db.Decimal(10, 2)
  priceTier        VendorPriceTier @default(MID)

  // Performance
  rating           Decimal? @db.Decimal(2, 1) // 1.0 - 5.0
  totalJobs        Int      @default(0)
  completedJobs    Int      @default(0)
  onTimePercentage Int?     // 0-100

  // Preferences
  preferredContactMethod ContactMethod @default(PHONE)
  callInstructions String?

  // Insurance & License
  insuranceExpiry  DateTime?
  licenseNumber    String?
  licenseExpiry    DateTime?

  // Status
  status           VendorStatus @default(ACTIVE)

  // Notes
  notes            String?  @db.Text

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  maintenanceRequests MaintenanceRequest[]
  documents           Document[]

  @@index([organizationId])
  @@index([status])
}

enum VendorCategory {
  PLUMBING
  ELECTRICAL
  HVAC
  APPLIANCE
  GENERAL_HANDYMAN
  LOCKSMITH
  PEST_CONTROL
  CLEANING
  LANDSCAPING
  ROOFING
  FLOORING
  PAINTING
  GENERAL_CONTRACTOR
  OTHER
}

enum VendorPriceTier {
  BUDGET
  MID
  PREMIUM
}

enum ContactMethod {
  PHONE
  TEXT
  EMAIL
}

enum VendorStatus {
  ACTIVE
  INACTIVE
  ON_VACATION
  DO_NOT_USE
}

// ============================================================
// MESSAGING & COMMUNICATIONS
// ============================================================

model Conversation {
  id               String   @id @default(cuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Type of conversation
  type             ConversationType

  // Optional context linking
  contextType      String?  // "maintenance_request", "lease", "application"
  contextId        String?  // ID of the related entity

  // For linking to maintenance request
  maintenanceRequestId String?
  maintenanceRequest   MaintenanceRequest? @relation(fields: [maintenanceRequestId], references: [id])

  // Subject/Title (optional)
  subject          String?

  // Status
  status           ConversationStatus @default(ACTIVE)

  // Last activity
  lastMessageAt    DateTime?
  lastMessagePreview String?

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  participants     ConversationParticipant[]
  messages         Message[]

  @@index([organizationId])
  @@index([type])
  @@index([status])
  @@index([contextType, contextId])
}

enum ConversationType {
  LANDLORD_TENANT
  INTERNAL          // Between staff
  SUPPORT           // Help/support tickets
  AI_ASSISTANT
}

enum ConversationStatus {
  ACTIVE
  ARCHIVED
  CLOSED
}

model ConversationParticipant {
  id               String   @id @default(cuid())
  conversationId   String
  conversation     Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Participant can be either a User or a Tenant
  userId           String?
  user             User?    @relation(fields: [userId], references: [id])
  tenantId         String?
  tenant           Tenant?  @relation(fields: [tenantId], references: [id])

  // Role in conversation
  role             ParticipantRole @default(PARTICIPANT)

  // Read tracking
  lastReadAt       DateTime?
  unreadCount      Int      @default(0)

  // Mute
  isMuted          Boolean  @default(false)

  // Timestamps
  joinedAt         DateTime @default(now())
  leftAt           DateTime?

  @@unique([conversationId, userId])
  @@unique([conversationId, tenantId])
  @@index([conversationId])
  @@index([userId])
  @@index([tenantId])
}

enum ParticipantRole {
  OWNER
  PARTICIPANT
  AI_AGENT
}

model Message {
  id               String   @id @default(cuid())
  conversationId   String
  conversation     Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Sender can be User, Tenant, or System/AI
  senderUserId     String?
  senderUser       User?    @relation("UserMessages", fields: [senderUserId], references: [id])
  senderTenantId   String?
  senderTenant     Tenant?  @relation("TenantMessages", fields: [senderTenantId], references: [id])
  isSystemMessage  Boolean  @default(false)
  isAiGenerated    Boolean  @default(false)

  // Content
  content          String   @db.Text
  contentType      MessageContentType @default(TEXT)

  // Attachments
  attachments      String[] // Array of file URLs

  // Delivery
  channel          MessageChannel @default(IN_APP)
  sentAt           DateTime @default(now())
  deliveredAt      DateTime?
  readAt           DateTime?

  // For external channels
  externalId       String?  // Twilio SID, etc.

  // AI Analysis (for future use)
  aiSentiment      String?
  aiSuggestedResponse String?

  // Steward AI Integration
  aiDraftId        String?  // Reference to AIActionLog for AI-drafted messages
  aiModified       Boolean  @default(false) // Was this AI draft edited by human?

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([conversationId])
  @@index([senderUserId])
  @@index([senderTenantId])
  @@index([sentAt])
}

enum MessageContentType {
  TEXT
  IMAGE
  FILE
  SYSTEM
  AI_SUGGESTION
}

enum MessageChannel {
  IN_APP
  SMS
  EMAIL
  WHATSAPP
}

// ============================================================
// DOCUMENTS & FILES
// ============================================================

model Document {
  id               String   @id @default(cuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // File Info
  name             String
  fileName         String   // Original file name
  mimeType         String
  fileSize         Int      // In bytes

  // Storage
  storageProvider  StorageProvider @default(LOCAL)
  storageKey       String   // S3 key, local path, or Cloudinary ID
  fileUrl          String?  // Public URL if available

  // Type & Category
  type             DocumentType
  category         String?  // User-defined category

  // Linked Entities (polymorphic - can be linked to multiple)
  businessEntityId String?
  businessEntity   BusinessEntity? @relation(fields: [businessEntityId], references: [id])
  propertyId       String?
  property         Property? @relation(fields: [propertyId], references: [id])
  unitId           String?
  unit             Unit?    @relation(fields: [unitId], references: [id])
  tenantId         String?
  tenant           Tenant?  @relation(fields: [tenantId], references: [id])
  leaseId          String?
  lease            Lease?   @relation(fields: [leaseId], references: [id])
  applicationId    String?
  application      Application? @relation(fields: [applicationId], references: [id])
  vendorId         String?
  vendor           Vendor?  @relation(fields: [vendorId], references: [id])
  maintenanceRequestId String?
  maintenanceRequest MaintenanceRequest? @relation(fields: [maintenanceRequestId], references: [id])

  // E-Signature
  signatureStatus  DocumentSignatureStatus @default(NOT_REQUIRED)
  signatureRequestId String? // DocuSign/HelloSign ID

  // Metadata
  description      String?
  tags             String[]

  // Access
  isPublic         Boolean  @default(false)

  // Upload info
  uploadedByUserId String?
  uploadedBy       User?    @relation(fields: [uploadedByUserId], references: [id])

  // Timestamps
  uploadedAt       DateTime @default(now())
  lastAccessedAt   DateTime?
  expiresAt        DateTime? // For temporary documents

  @@index([organizationId])
  @@index([type])
  @@index([businessEntityId])
  @@index([propertyId])
  @@index([unitId])
  @@index([tenantId])
  @@index([leaseId])
  @@index([vendorId])
}

// ============================================================
// E-SIGN MODELS
// ============================================================

model ESignDocument {
  id               String   @id @default(cuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Document info
  name             String
  description      String?
  originalFileUrl  String
  originalFileName String
  fileSize         Int
  mimeType         String
  pageCount        Int      @default(1)

  // Status
  status           ESignDocumentStatus @default(DRAFT)

  // Relations to other entities
  propertyId       String?
  property         Property? @relation(fields: [propertyId], references: [id])
  leaseId          String?
  lease            Lease?    @relation(fields: [leaseId], references: [id])
  applicationId    String?
  application      Application? @relation(fields: [applicationId], references: [id])

  // Settings
  message          String?   // Message to signers
  reminderEnabled  Boolean   @default(true)
  reminderDays     Int       @default(3)

  // Created by
  createdById      String
  createdBy        User      @relation(fields: [createdById], references: [id])

  // Timestamps
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  sentAt           DateTime?
  completedAt      DateTime?
  expiresAt        DateTime?

  // Relations
  signers          ESignSigner[]
  fields           ESignField[]
  auditLogs        ESignAuditLog[]

  @@index([organizationId])
  @@index([status])
  @@index([propertyId])
  @@index([leaseId])
}

model ESignSigner {
  id               String   @id @default(cuid())
  documentId       String
  document         ESignDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // Signer info
  name             String
  email            String
  phone            String?
  role             SignerRole @default(OTHER)
  order            Int       @default(1)

  // Reference to existing entities
  tenantId         String?
  tenant           Tenant?   @relation(fields: [tenantId], references: [id])
  userId           String?
  user             User?     @relation("ESignSignerUser", fields: [userId], references: [id])

  // Status
  status           SignerStatus @default(PENDING)
  viewedAt         DateTime?
  signedAt         DateTime?
  declinedAt       DateTime?
  declineReason    String?

  // Security
  accessToken      String?   @unique @default(cuid())
  accessCode       String?   // Optional PIN
  signatureIp      String?
  signatureUserAgent String?

  // Notification tracking
  signingUrl       String?
  lastReminderSentAt DateTime?

  // UI color
  color            String    @default("#3B82F6")

  // Timestamps
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  fields           ESignField[]

  @@index([documentId])
  @@index([email])
  @@index([accessToken])
}

model ESignField {
  id               String   @id @default(cuid())
  documentId       String
  document         ESignDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  signerId         String
  signer           ESignSigner @relation(fields: [signerId], references: [id], onDelete: Cascade)

  // Field type
  type             SigningFieldType
  label            String?
  placeholder      String?
  required         Boolean   @default(true)

  // Position on document
  pageNumber       Int
  x                Float     // Percentage from left (0-100)
  y                Float     // Percentage from top (0-100)
  width            Float     // Percentage of page width
  height           Float     // Percentage of page height

  // Field options
  options          String[]  @default([])
  validation       String?
  maxLength        Int?

  // Value
  value            String?
  signedAt         DateTime?

  // Timestamps
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([documentId])
  @@index([signerId])
}

model ESignAuditLog {
  id               String   @id @default(cuid())
  documentId       String
  document         ESignDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // Action info
  action           ESignAuditAction
  actorType        String    // USER, SIGNER, SYSTEM
  actorId          String?
  actorEmail       String?
  actorName        String?

  // Additional data
  metadata         Json?
  ipAddress        String?
  userAgent        String?

  // Timestamp
  createdAt        DateTime  @default(now())

  @@index([documentId])
  @@index([action])
}

model ESignTemplate {
  id               String   @id @default(cuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Template info
  name             String
  description      String?
  fileUrl          String
  fileName         String
  pageCount        Int       @default(1)

  // Default signers configuration
  signerRoles      Json?     // Array of {role, order}

  // Default fields configuration
  fieldPlacements  Json?     // Array of field definitions

  // Settings
  isActive         Boolean   @default(true)

  // Timestamps
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([organizationId])
}

// E-Sign Enums
enum ESignDocumentStatus {
  DRAFT
  PENDING_SIGNATURES
  PARTIALLY_SIGNED
  COMPLETED
  EXPIRED
  CANCELLED
}

enum SignerRole {
  LANDLORD
  TENANT
  CO_SIGNER
  WITNESS
  OTHER
}

enum SignerStatus {
  PENDING
  VIEWED
  SIGNED
  DECLINED
}

enum SigningFieldType {
  SIGNATURE
  INITIALS
  DATE
  TEXT
  CHECKBOX
  DROPDOWN
}

enum ESignAuditAction {
  DOCUMENT_CREATED
  DOCUMENT_UPDATED
  DOCUMENT_SENT
  DOCUMENT_VIEWED
  DOCUMENT_COMPLETED
  DOCUMENT_EXPIRED
  DOCUMENT_CANCELLED
  SIGNER_ADDED
  SIGNER_REMOVED
  SIGNER_VIEWED
  SIGNER_SIGNED
  SIGNER_DECLINED
  FIELD_ADDED
  FIELD_REMOVED
  FIELDS_UPDATED
  REMINDER_SENT
  NOTIFICATION_SENT
}

enum StorageProvider {
  LOCAL
  S3
  SUPABASE
}

enum DocumentType {
  // Lease Documents
  LEASE_AGREEMENT
  LEASE_ADDENDUM
  LEASE_RENEWAL

  // Tenant Documents
  RENTAL_APPLICATION
  ID_DOCUMENT
  INCOME_VERIFICATION
  SCREENING_REPORT

  // Inspection Documents
  MOVE_IN_INSPECTION
  MOVE_OUT_INSPECTION

  // Financial Documents
  PAYMENT_RECEIPT
  INVOICE

  // Insurance Documents
  INSURANCE_CERTIFICATE
  INSURANCE_POLICY

  // Notices
  NOTICE
  RENT_INCREASE_NOTICE
  LEASE_VIOLATION_NOTICE
  EVICTION_NOTICE

  // Entity/Corporate Documents
  OPERATING_AGREEMENT
  ARTICLES_OF_ORGANIZATION
  CERTIFICATE_OF_FORMATION
  EIN_LETTER
  ANNUAL_REPORT
  RESOLUTION
  AMENDMENT
  REGISTERED_AGENT_LETTER
  GOOD_STANDING_CERTIFICATE
  BYLAWS

  // Property Ownership Documents
  DEED
  TITLE_INSURANCE
  SURVEY
  APPRAISAL
  PROPERTY_TAX_RECORD
  HOA_DOCUMENTS

  // Compliance Documents
  LEAD_PAINT_DISCLOSURE
  FAIR_HOUSING_NOTICE
  MOLD_DISCLOSURE
  BED_BUG_POLICY
  ENVIRONMENTAL_REPORT
  RADON_DISCLOSURE

  // Other
  PHOTO
  OTHER
}

enum DocumentSignatureStatus {
  NOT_REQUIRED
  PENDING
  SENT
  PARTIALLY_SIGNED
  COMPLETED
  EXPIRED
  DECLINED
}

// ============================================================
// NOTIFICATIONS
// ============================================================

model Notification {
  id               String   @id @default(cuid())

  // Recipient (can be User or Tenant)
  userId           String?
  user             User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenantId         String?
  tenant           Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Content
  type             NotificationType
  title            String
  body             String   @db.Text

  // Action
  actionUrl        String?
  actionLabel      String?

  // Delivery Channels
  channels         NotificationChannel[]

  // Status per channel
  inAppReadAt      DateTime?
  emailSentAt      DateTime?
  smsSentAt        DateTime?
  pushSentAt       DateTime?

  // External IDs
  emailMessageId   String?
  smsMessageId     String?

  // Timestamps
  createdAt        DateTime @default(now())
  expiresAt        DateTime?

  @@index([userId])
  @@index([tenantId])
  @@index([type])
  @@index([createdAt])
}

enum NotificationType {
  // Payments
  RENT_DUE
  RENT_OVERDUE
  PAYMENT_RECEIVED
  PAYMENT_FAILED

  // Lease
  LEASE_EXPIRING
  LEASE_RENEWAL_OFFER
  LEASE_SIGNED

  // Maintenance
  MAINTENANCE_SUBMITTED
  MAINTENANCE_SCHEDULED
  MAINTENANCE_COMPLETED

  // Applications
  APPLICATION_RECEIVED
  APPLICATION_APPROVED
  APPLICATION_DECLINED

  // Messages
  NEW_MESSAGE

  // System
  SYSTEM_ANNOUNCEMENT
  ACCOUNT_UPDATE
}

enum NotificationChannel {
  IN_APP
  EMAIL
  SMS
  PUSH
}

// ============================================================
// ACCOUNTING & REPORTING
// ============================================================

// For tracking user's favorite reports
model UserReportFavorite {
  id         String   @id @default(cuid())
  userId     String
  reportType String
  createdAt  DateTime @default(now())

  @@unique([userId, reportType])
  @@index([userId])
}

// For tracking expenses not tied to maintenance (e.g., property taxes, insurance)
model Expense {
  id               String   @id @default(cuid())
  organizationId   String

  // What it's for
  propertyId       String?
  unitId           String?
  vendorId         String?

  // Details
  category         ExpenseCategory
  description      String
  amount           Decimal  @db.Decimal(10, 2)

  // Date
  expenseDate      DateTime

  // Payment
  paymentMethod    PaymentMethod?
  paymentReference String?
  paidAt           DateTime?

  // Receipts
  receiptUrl       String?

  // Tax
  isTaxDeductible  Boolean  @default(true)

  // Notes
  notes            String?

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([organizationId])
  @@index([propertyId])
  @@index([category])
  @@index([expenseDate])
}

enum ExpenseCategory {
  REPAIRS_MAINTENANCE
  PROPERTY_TAX
  INSURANCE
  UTILITIES
  PROPERTY_MANAGEMENT
  LEGAL_PROFESSIONAL
  ADVERTISING
  SUPPLIES
  TRAVEL
  HOA_FEES
  MORTGAGE_INTEREST
  DEPRECIATION
  OTHER
}

// ============================================================
// AUDIT LOGGING
// ============================================================

model AuditLog {
  id               String   @id @default(cuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Who performed the action
  userId           String?
  user             User?    @relation(fields: [userId], references: [id])

  // What happened
  action           AuditAction
  entityType       String   // "lease", "payment", "tenant", etc.
  entityId         String

  // Details
  description      String

  // Changes (for updates)
  previousValues   Json?    // What it was before
  newValues        Json?    // What it changed to

  // Context
  ipAddress        String?
  userAgent        String?

  // Timestamps
  performedAt      DateTime @default(now())

  @@index([organizationId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([performedAt])
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  EXPORT
  LOGIN
  LOGOUT
  PAYMENT_RECEIVED
  PAYMENT_REFUNDED
  CHARGE_CREATED
  CHARGE_WAIVED
  LEASE_CREATED
  LEASE_SIGNED
  LEASE_TERMINATED
  MAINTENANCE_CREATED
  MAINTENANCE_COMPLETED
  DOCUMENT_UPLOADED
  DOCUMENT_SIGNED
  NOTIFICATION_SENT
  // AI-related actions
  AI_COMPLETION
  AI_TOOL_CALL
  AI_VOICE_TRANSCRIPTION
  AI_VOICE_SYNTHESIS
  AI_OCR_EXTRACTION
  AI_DRAFT_GENERATED
  AI_DRAFT_APPROVED
  AI_DRAFT_REJECTED
  AI_AUTO_ACTION
  AI_SESSION_STARTED
  AI_SESSION_ENDED
}

// ============================================================
// STEWARD AI SYSTEM
// ============================================================

// AI Action Logging - tracks all AI interactions for audit trail
model AIActionLog {
  id               String   @id @default(cuid())
  organizationId   String

  // User/Session context
  userId           String?
  sessionId        String

  // Action details
  module           AIModule
  actionType       String

  // Input/Output
  inputPrompt      String?  @db.Text
  inputContext     Json?
  inputFiles       String[]

  outputResponse   String?  @db.Text
  outputToolCalls  Json?
  outputContent    String?  @db.Text

  // Human decision tracking
  humanDecision    HumanDecision @default(PENDING)
  modifiedContent  String?  @db.Text
  decidedByUserId  String?
  decidedAt        DateTime?

  // Configuration
  automationLevel  AutomationLevel

  // Metrics
  tokensUsed       Int      @default(0)
  latencyMs        Int      @default(0)
  provider         String   @default("")
  model            String   @default("")

  // Timestamps
  createdAt        DateTime @default(now())

  @@index([organizationId])
  @@index([userId])
  @@index([sessionId])
  @@index([module])
  @@index([createdAt])
}

// Steward Conversation Sessions - maintains conversation state
model StewardSession {
  id               String   @id @default(cuid())
  organizationId   String
  userId           String

  // Session context
  module           AIModule?
  contextType      String?  // 'maintenance_request', 'lease', etc.
  contextId        String?

  // Conversation state
  messages         Json     // Array of conversation messages
  state            Json?    // Module-specific state

  // Status
  isActive         Boolean  @default(true)

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  lastActivityAt   DateTime @default(now())

  @@index([organizationId])
  @@index([userId])
  @@index([isActive])
}

// AI Configuration per organization
model AIConfiguration {
  id               String   @id @default(cuid())
  organizationId   String   @unique

  // Provider preferences
  preferredProvider String  @default("openai") // 'openai' | 'anthropic'
  openaiApiKey     String?  // Encrypted
  anthropicApiKey  String?  // Encrypted

  // Voice settings
  elevenLabsApiKey String?  // Encrypted
  voiceId          String?
  voiceEnabled     Boolean  @default(true)

  // Automation levels (JSON for flexibility)
  automationConfig Json     @default("{}")

  // Feature flags
  featuresEnabled  String[] @default([])

  // Usage tracking
  monthlyTokenBudget Int?
  currentMonthTokens Int    @default(0)
  lastTokenResetAt DateTime?

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([organizationId])
}

// Document extraction cache - stores OCR/parsing results
model DocumentExtraction {
  id               String   @id @default(cuid())
  documentId       String   @unique

  // Extraction results
  extractedData    Json
  rawText          String   @db.Text
  confidence       Float

  // Validation status
  isValidated      Boolean  @default(false)
  validatedByUserId String?
  validatedAt      DateTime?

  // Applied status
  isApplied        Boolean  @default(false)
  appliedEntities  Json?    // { propertyId, unitId, tenantIds[], leaseId }

  // Timestamps
  createdAt        DateTime @default(now())

  @@index([documentId])
}

// Voice call logs - tracks AI-assisted phone calls
model VoiceCallLog {
  id               String   @id @default(cuid())
  organizationId   String

  // Participants
  callerUserId     String?
  recipientType    String   // 'tenant' | 'vendor'
  recipientId      String

  // Call details
  direction        String   // 'outbound' | 'inbound'
  status           String   // 'initiated' | 'ringing' | 'in_progress' | 'completed' | 'failed'
  duration         Int?     // seconds

  // AI involvement
  aiAssisted       Boolean  @default(false)
  aiTranscript     String?  @db.Text
  aiSummary        String?  @db.Text

  // External references
  externalCallId   String?  // Twilio/provider call ID
  recordingUrl     String?

  // Timestamps
  startedAt        DateTime @default(now())
  endedAt          DateTime?

  @@index([organizationId])
  @@index([recipientType, recipientId])
}

// AI Module types
enum AIModule {
  COMMUNICATIONS
  MAINTENANCE
  ONBOARDING
  LEASING
  COMPLIANCE
  ACCOUNTING
}

// Human decision on AI-generated content
enum HumanDecision {
  PENDING
  APPROVED
  REJECTED
  MODIFIED
  AUTO_EXECUTED
}

// Automation levels for AI actions
enum AutomationLevel {
  MANUAL           // AI suggests, human must initiate
  SUGGEST          // AI drafts, human must approve
  AUTO_WITH_REVIEW // AI acts, human can review/undo
  FULLY_AUTO       // AI acts autonomously
}

// ============================================================
// STRIPE CONNECT & PAYMENTS
// ============================================================

enum TenantPaymentMethodType {
  US_BANK_ACCOUNT
  CARD
  APPLE_PAY
  GOOGLE_PAY
}

enum BankVerificationStatus {
  PENDING
  VERIFIED
  FAILED
  INSTANT_VERIFIED
}

enum PaymentAttemptStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELLED
}

enum PayoutStatus {
  PAYOUT_PENDING
  IN_TRANSIT
  PAID
  PAYOUT_FAILED
  PAYOUT_CANCELLED
}

enum DisputeStatus {
  NEEDS_RESPONSE
  UNDER_REVIEW
  WON
  LOST
  CHARGE_REFUNDED
}

// Stripe Connect account details for landlords/organizations
model StripeConnectAccount {
  id                        String   @id @default(cuid())
  organizationId            String   @unique
  organization              Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  stripeAccountId           String   @unique

  // Account status from Stripe
  chargesEnabled            Boolean  @default(false)
  payoutsEnabled            Boolean  @default(false)
  detailsSubmitted          Boolean  @default(false)

  // Requirements tracking
  currentlyDue              String[]
  eventuallyDue             String[]
  pastDue                   String[]
  disabledReason            String?

  // Capabilities
  cardPaymentsCapability    String   @default("inactive")
  transfersCapability       String   @default("inactive")
  usBankAccountCapability   String   @default("inactive")

  // Default bank account for payouts
  defaultBankAccountId      String?
  defaultBankAccountLast4   String?
  defaultBankAccountBankName String?

  // Timestamps
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
  lastSyncedAt              DateTime?

  @@index([stripeAccountId])
}

// Stripe Customer record for tenants
model StripeCustomer {
  id                        String   @id @default(cuid())
  tenantId                  String   @unique
  tenant                    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  stripeCustomerId          String   @unique

  // Customer details synced from Stripe
  email                     String?
  name                      String?

  // Default payment method
  defaultPaymentMethodId    String?

  // Timestamps
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  @@index([stripeCustomerId])
}

// Tenant payment methods (bank accounts and cards)
model TenantPaymentMethod {
  id                        String   @id @default(cuid())
  tenantId                  String
  tenant                    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Stripe identifiers
  stripeCustomerId          String
  stripePaymentMethodId     String   @unique

  // Payment method type
  type                      TenantPaymentMethodType

  // For bank accounts (via Financial Connections)
  bankName                  String?
  bankAccountLast4          String?
  bankAccountType           String?  // checking, savings
  financialConnectionsAccountId String?
  verificationStatus        BankVerificationStatus @default(PENDING)

  // For cards
  cardBrand                 String?  // visa, mastercard, amex, etc.
  cardLast4                 String?
  cardExpMonth              Int?
  cardExpYear               Int?
  cardFunding               String?  // credit, debit, prepaid

  // For wallets
  walletType                String?  // apple_pay, google_pay

  // Status
  isDefault                 Boolean  @default(false)
  isActive                  Boolean  @default(true)

  // Metadata
  nickname                  String?

  // Timestamps
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  // Relations
  payments                  Payment[]
  scheduledPayments         ScheduledPayment[]

  @@index([tenantId])
  @@index([stripeCustomerId])
  @@index([stripePaymentMethodId])
}

// AutoPay configuration for recurring rent payments
model ScheduledPayment {
  id                        String   @id @default(cuid())
  leaseId                   String
  lease                     Lease    @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  tenantId                  String
  tenant                    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  paymentMethodId           String
  paymentMethod             TenantPaymentMethod @relation(fields: [paymentMethodId], references: [id])

  // Schedule
  dayOfMonth                Int      // 1-28
  amount                    Decimal  @db.Decimal(10, 2)

  // What charges to pay
  chargeTypes               ChargeType[]

  // Status
  isActive                  Boolean  @default(true)

  // Last execution
  lastProcessedAt           DateTime?
  lastProcessedChargeId     String?
  lastProcessedStatus       String?

  // Timestamps
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  @@unique([leaseId, tenantId])
  @@index([leaseId])
  @@index([tenantId])
  @@index([isActive])
}

// Track payment processing attempts
model PaymentAttempt {
  id                        String   @id @default(cuid())
  paymentId                 String?
  payment                   Payment? @relation(fields: [paymentId], references: [id])
  chargeId                  String
  charge                    Charge   @relation(fields: [chargeId], references: [id])

  // Stripe details
  stripePaymentIntentId     String?  @unique
  stripePaymentMethodId     String?

  // Attempt details
  amount                    Decimal  @db.Decimal(10, 2)
  attemptNumber             Int      @default(1)

  // Status
  status                    PaymentAttemptStatus
  failureCode               String?
  failureMessage            String?

  // Timestamps
  attemptedAt               DateTime @default(now())
  succeededAt               DateTime?

  @@index([paymentId])
  @@index([chargeId])
  @@index([stripePaymentIntentId])
}

// Payout tracking for landlord disbursements
model Payout {
  id                        String   @id @default(cuid())
  organizationId            String
  organization              Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Stripe details
  stripePayoutId            String   @unique
  stripeTransferId          String?

  // Amount
  amount                    Decimal  @db.Decimal(10, 2)
  currency                  String   @default("usd")

  // Fees
  platformFee               Decimal  @db.Decimal(10, 2) @default(0)
  stripeFee                 Decimal  @db.Decimal(10, 2) @default(0)
  netAmount                 Decimal  @db.Decimal(10, 2)

  // Destination
  destinationBankLast4      String?
  destinationBankName       String?

  // Status
  status                    PayoutStatus
  failureCode               String?
  failureMessage            String?

  // Timing
  expectedArrivalDate       DateTime?
  arrivedAt                 DateTime?

  // Source payments
  sourcePaymentIds          String[]

  // Timestamps
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  // Relations
  payments                  Payment[]

  @@index([organizationId])
  @@index([stripePayoutId])
  @@index([status])
}

// Dispute tracking
model Dispute {
  id                        String   @id @default(cuid())
  paymentId                 String   @unique
  payment                   Payment  @relation(fields: [paymentId], references: [id])

  stripeDisputeId           String   @unique

  // Dispute details
  amount                    Decimal  @db.Decimal(10, 2)
  currency                  String   @default("usd")
  reason                    String
  status                    DisputeStatus

  // Evidence
  evidenceSubmitted         Boolean  @default(false)
  evidenceDueBy             DateTime?

  // Resolution
  outcome                   String?
  resolvedAt                DateTime?

  // Timestamps
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  @@index([status])
}

// Stripe webhook event tracking for idempotency
model StripeWebhookEvent {
  id                        String   @id @default(cuid())
  stripeEventId             String   @unique
  eventType                 String
  payload                   String   @db.Text

  // Processing status
  processedAt               DateTime?
  error                     String?
  retryCount                Int      @default(0)

  // Timestamps
  receivedAt                DateTime @default(now())

  @@index([eventType])
  @@index([processedAt])
}

// Reconciliation log for tracking discrepancies
model ReconciliationLog {
  id                        String   @id @default(cuid())
  organizationId            String

  // What was reconciled
  entityType                String   // 'payment', 'payout', 'refund'
  entityId                  String
  stripeId                  String

  // Discrepancy details
  discrepancyType           String
  expectedValue             String
  actualValue               String

  // Resolution
  isResolved                Boolean  @default(false)
  resolvedAt                DateTime?
  resolvedByUserId          String?
  resolution                String?

  // Timestamps
  detectedAt                DateTime @default(now())

  @@index([organizationId])
  @@index([isResolved])
  @@index([entityType, entityId])
}
